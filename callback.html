<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhanTool - Processando...</title>
    <link rel="stylesheet" href="media/login_khan.css">
    <style>
        .loading-container {
            text-align: center;
            padding: 4rem 2rem;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="fixed-background"></div>
    <div class="container">
        <div class="loading-container">
            <div class="spinner"></div>
            <h2>Processando autenticação...</h2>
            <p>Aguarde enquanto verificamos sua participação no servidor.</p>
        </div>
    </div>
    <script>
        const CLIENT_ID = '1403888749976490095';
        const CLIENT_SECRET = 'LCMv8wKGWqU44yxPz2Ho8ghF8uxw0CTD';
        const REDIRECT_URI = 'https://khantool.camposcloud.app/callback.html';
        const GUILD_ID = '1298477766290837554';

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                window.location.href = 'auth.html?error=auth_failed';
                return;
            }
            
            if (code) {
                try {
                    await exchangeCodeForToken(code);
                } catch (error) {
                    console.error('Erro na autenticação:', error);
                    window.location.href = 'auth.html?error=auth_failed';
                }
            } else {
                window.location.href = 'auth.html?error=no_code';
            }
        });

        async function exchangeCodeForToken(code) {
            try {
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                    }),
                });

                if (!tokenResponse.ok) {
                    throw new Error('Falha ao obter token');
                }

                const tokenData = await tokenResponse.json();
                localStorage.setItem('discord_access_token', tokenData.access_token);
                
                await verifyServerMembership(tokenData.access_token);
            } catch (error) {
                throw error;
            }
        }

        async function verifyServerMembership(token) {
            try {
                const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (!guildsResponse.ok) {
                    throw new Error('Falha ao verificar servidores');
                }

                const guilds = await guildsResponse.json();
                const isMember = guilds.some(guild => guild.id === GUILD_ID);

                if (isMember) {
                    localStorage.setItem('discord_verified', 'true');
                    localStorage.setItem('verification_time', Date.now().toString());
                    window.location.href = 'install.html';
                } else {
                    window.location.href = 'auth.html?error=not_member';
                }
            } catch (error) {
                throw error;
            }
        }
    </script>
</body>
</html>
